<script lang="ts">
	import type { LayoutData } from './$types';

	import { onMount } from 'svelte';

	import {
		connected,
		provider,
		signer,
		chainId,
		signerAddress,
		defaultEvmStores
	} from 'svelte-ethers-store';
	import Web3Modal from 'web3modal';

	// import IERC20 from '@openzeppelin/contracts/build/contracts/IERC20.json';

	let type;
	let pending = false;
	let web3Modal: Web3Modal;

	export let data: LayoutData;

	// const LINK_ON_RINKEBY = '0x01be23585060835e02b77ef475b0cc51aa1e0709';
	// defaultEvmStores.attachContract('link', LINK_ON_RINKEBY, IERC20.abi.toString());

	onMount(async () => {
		web3Modal = new Web3Modal({
			network: 'goerli', // optional
			cacheProvider: true, // optional
			providerOptions: {} // required
		});

		if (window.ethereum) {
			await connect();
			// const provider = new ethers.providers.Web3Provider(window.ethereum);
			// const signer = provider.getSigner();
			// await window.ethereum.enable();
			// defaultEvmStores.setProvider(provider);

			// console.log('$connected', defaultEvmStores.$connected);
			// console.log('$provider', defaultEvmStores.$provider);
			// console.log('$signer', defaultEvmStores.$signer);
		}
	});

	const connect = async () => {
		pending = true;
		try {
			const handler = {
				Browser: () => defaultEvmStores.setProvider(),
				// Localhost4: () => defaultEvmStores.setProvider('http://127.0.0.1:8545', 4),
				// LocalhostNull: () => defaultEvmStores.setProvider('http://127.0.0.1:8545', null),
				// RPC: () => defaultEvmStores.setProvider('https://rpc.xdaichain.com/'),
				// Infura: () =>
				// 	defaultEvmStores.setProvider(new ethers.providers.InfuraProvider('ropsten'), null),
				// Etherscan: () =>
				// 	defaultEvmStores.setProvider(new ethers.providers.EtherscanProvider('rinkeby'), null),
				// Alchemy: () =>
				// 	defaultEvmStores.setProvider(
				// 		new ethers.providers.AlchemyProvider('matic'),
				// 		import.meta.env.ALCHEMY_API_KEY
				// 	),
				Alchemy: () =>
					defaultEvmStores.setProvider(
						`https://eth-goerli.alchemyapi.io/v2/${data.ALCHEMY_API_KEY}`
					)
				// Clouflare: () =>
				// 	defaultEvmStores.setProvider(new ethers.providers.CloudflareProvider(), null)
			};

			// console.log(handler);
			// console.log(type);
			// await handler[type]();
			console.log(import.meta.env.ALCHEMY_API_KEY);
			// await defaultEvmStores.setProvider(new ethers.providers.AlchemyProvider('goerli'));
			await defaultEvmStores.setProvider(
				`https://eth-goerli.alchemyapi.io/v2/${data.ALCHEMY_API_KEY}`
			);

			console.log('$connected', defaultEvmStores.$connected);
			console.log('$provider', defaultEvmStores.$provider);
			console.log('$signer', defaultEvmStores.$signer);
			pending = false;
		} catch (e) {
			console.log(e);
			pending = false;
		}
	};

	const enable = async () => {
		pending = true;
		const provider = await web3Modal.connect();
		// let WalletConnectProvider = window.WalletConnectProvider.default;
		// const provider2 = new WalletConnectProvider({
		// 	infuraId: import.meta.env.VITE_INFURA_API_KEY
		// });
		// //  Enable session (triggers QR Code modal)
		const signer = provider.getSigner();
		// await provider.enable();
		defaultEvmStores.setProvider(provider);
		pending = false;
	};

	const disconnect = async () => {
		await defaultEvmStores.disconnect();
		pending = false;
	};

	$: network = $connected ? $provider.getNetwork() : '';
	$: account = $connected && $signer ? $signer.getAddress() : '';
</script>

<svelte:head>
	<title>About</title>
</svelte:head>

<div class="content">
	<h1>svelte-ethers-store: using setProvider()</h1>

	<p>
		Before using any stores, you need to establish a connection to an EVM blockchain. Check the code
		and the README to learn more.
	</p>

	<p>Choose the provider:</p>
	<button class="button" disabled={pending} on:click={connect}>Connect with</button>
	<select bind:value={type}>
		<option value="Browser">Browser (window.ethereum)</option>
		<!-- <option value="Localhost">Localhost (http://127.0.0.1:8545)</option> -->
		<!-- <option value="Localhost4">Localhost using account index 4</option>
		<option value="LocalhostNull">Localhost but only provider (no signer)</option>
		<option value="RPC">https://rpc.xdaichain.com/ (RPC)</option>
		<option value="Infura">ethers.providers.InfuraProvider('ropsten')</option>
		<option value="Etherscan">ethers.providers.EtherscanProvider('rinkeby')</option> -->
		<!-- <option value="Alchemy">ethers.providers.AlchemyProvider('matic')</option> -->
		<option value="Alchemy">ethers.providers.AlchemyProvider('goerli')</option>
		<!-- <option value="Clouflare">ethers.providers.CloudflareProvider()</option> -->
	</select>

	<button class="button" disabled={pending} on:click={enable}>Connect with Web3modal</button>
	{#if pending}connecting...{/if}

	{#if $connected}
		<p>
			Well done, you are now connected to the blockchain (account {$signerAddress}) Stores values:
		</p>

		<h3>Use the stores in your HTML to get responsive value of evm connection</h3>

		<ul>
			<li>$chainId: {$chainId}</li>
			<li>$signerAddres: {$signerAddress}</li>
		</ul>

		<h3>await is also possible</h3>

		<p>
			{#await network}
				<span>waiting...</span>
			{:then value}
				<span>Network: {JSON.stringify(value)}</span>
			{/await}

			{#await account}
				<span>waiting...</span>
			{:then value}
				with {#if value}account {value}{:else}no account{/if}
			{/await}
		</p>

		<button class="button" on:click={disconnect}> Disconnect </button>
	{/if}
</div>

<style>
	.content {
		width: 100%;
		max-width: var(--column-width);
		margin: var(--column-margin-top) auto 0 auto;
	}
</style>
